<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Vitalia ‚Äî Ton Plan Bien-√™tre</title>
<link href="https://fonts.googleapis.com/css2?family=Fraunces:ital,opsz,wght@0,9..144,300;0,9..144,500;0,9..144,700;1,9..144,400&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --cream: #FAF7F2;
    --warm-white: #FFFEF9;
    --terracotta: #C4714A;
    --terracotta-light: #E8956D;
    --sage: #7A9E7E;
    --sage-light: #A8C5AC;
    --peach: #F2C4A0;
    --golden: #E8B84B;
    --dusty-rose: #D4936A;
    --deep-brown: #3D2B1F;
    --mid-brown: #7A5C4A;
    --text-light: #9E8070;
    --mirtille-purple: #8E44AD;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'DM Sans', sans-serif; background: var(--cream); color: var(--deep-brown); min-height: 100vh; overflow-x: hidden; }
  body::before { content: ''; position: fixed; inset: 0; background: radial-gradient(ellipse at 20% 10%, rgba(196,113,74,0.08) 0%, transparent 50%), radial-gradient(ellipse at 80% 80%, rgba(122,158,126,0.10) 0%, transparent 50%); pointer-events: none; z-index: 0; }

  /* HEADER */
  .header { position: relative; z-index: 10; padding: 20px 24px 0; display: flex; justify-content: space-between; align-items: center; }
  .logo { font-family: 'Fraunces', serif; font-size: 26px; font-weight: 700; color: var(--terracotta); letter-spacing: -0.5px; }
  .logo span { color: var(--sage); }
  .header-actions { display: flex; align-items: center; gap: 10px; }
  .date-badge { background: var(--warm-white); border: 1.5px solid var(--peach); border-radius: 20px; padding: 6px 14px; font-size: 13px; color: var(--mid-brown); font-weight: 500; }
  .bookmark-btn { background: var(--warm-white); border: 1.5px solid var(--peach); border-radius: 20px; padding: 6px 14px; font-size: 13px; color: var(--mid-brown); font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 5px; transition: all 0.2s; font-family: 'DM Sans', sans-serif; }
  .bookmark-btn:hover { background: var(--peach); border-color: var(--terracotta); color: var(--terracotta); }

  /* SAVED PANEL */
  .saved-panel { position: fixed; top: 0; right: 0; bottom: 0; width: 340px; max-width: 90vw; background: var(--warm-white); z-index: 60; transform: translateX(100%); transition: transform 0.4s cubic-bezier(0.32,0.72,0,1); box-shadow: -8px 0 40px rgba(61,43,31,0.12); display: flex; flex-direction: column; }
  .saved-panel.open { transform: translateX(0); }
  .saved-panel-header { display: flex; justify-content: space-between; align-items: center; padding: 24px 20px 16px; border-bottom: 1px solid rgba(196,113,74,0.12); }
  .saved-panel-title { font-family: 'Fraunces', serif; font-size: 18px; font-weight: 700; color: var(--deep-brown); }
  .saved-panel-close { width: 32px; height: 32px; background: var(--cream); border: none; border-radius: 10px; cursor: pointer; font-size: 16px; color: var(--mid-brown); }
  .saved-list { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 12px; }
  .saved-empty { text-align: center; padding: 40px 20px; color: var(--text-light); font-size: 14px; line-height: 1.6; }
  .saved-empty-icon { font-size: 36px; margin-bottom: 12px; }
  .saved-item { background: var(--cream); border-radius: 16px; padding: 14px 16px; border: 1px solid rgba(196,113,74,0.12); }
  .saved-item-title { font-family: 'Fraunces', serif; font-size: 14px; font-weight: 600; color: var(--deep-brown); margin-bottom: 4px; }
  .saved-item-meta { font-size: 11px; color: var(--text-light); display: flex; gap: 8px; align-items: center; }
  .saved-item-delete { position: absolute; top: 10px; right: 10px; width: 24px; height: 24px; background: none; border: none; cursor: pointer; font-size: 14px; color: var(--text-light); border-radius: 6px; transition: background 0.2s; }
  .saved-item-delete:hover { background: rgba(196,113,74,0.15); color: var(--terracotta); }
  .saved-item-header { display: flex; justify-content: space-between; align-items: flex-start; cursor: pointer; gap: 8px; }
  .saved-item-header:hover .saved-item-title { color: var(--terracotta); }
  .saved-expand-arrow { font-size: 11px; color: var(--text-light); flex-shrink: 0; margin-top: 4px; transition: color 0.2s; }
  .saved-item-stars { display: flex; gap: 2px; margin-top: 3px; }
  .saved-item-detail { padding-top: 0; }
  .saved-item-ingredients { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 12px; }
  .saved-ing-tag { background: var(--warm-white); border: 1px solid rgba(196,113,74,0.15); border-radius: 14px; padding: 2px 8px; font-size: 11px; color: var(--mid-brown); }
  .saved-item-steps { display: flex; flex-direction: column; gap: 7px; margin-top: 10px; }
  .saved-step { display: flex; gap: 8px; align-items: flex-start; font-size: 12px; color: var(--mid-brown); line-height: 1.4; }
  .saved-step-num { width: 18px; height: 18px; background: var(--terracotta); color: white; border-radius: 50%; font-size: 10px; font-weight: 700; display: flex; align-items: center; justify-content: center; flex-shrink: 0; margin-top: 1px; }
  .saved-item-tip { margin-top: 8px; background: rgba(232,184,75,0.1); border-left: 3px solid var(--golden); border-radius: 0 6px 6px 0; padding: 6px 10px; font-size: 11.5px; color: var(--mid-brown); font-style: italic; margin-bottom: 4px; }

  /* HERO */
  .hero { position: relative; z-index: 5; padding: 28px 24px 0; }
  .hero-card { background: linear-gradient(135deg, var(--terracotta) 0%, var(--dusty-rose) 60%, var(--golden) 100%); border-radius: 28px; padding: 28px 24px 24px; position: relative; overflow: hidden; box-shadow: 0 12px 40px rgba(196,113,74,0.25); }
  .hero-card::before { content: ''; position: absolute; top: -30px; right: -30px; width: 160px; height: 160px; background: rgba(255,255,255,0.08); border-radius: 50%; }
  .hero-greeting { font-family: 'Fraunces', serif; font-size: 13px; font-weight: 300; color: rgba(255,255,255,0.75); text-transform: uppercase; letter-spacing: 2px; margin-bottom: 8px; }
  .hero-message { font-family: 'Fraunces', serif; font-size: 20px; font-weight: 500; color: #fff; line-height: 1.45; max-width: 240px; margin-bottom: 16px; position: relative; z-index: 2; }
  .hero-score { display: inline-flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.2); backdrop-filter: blur(10px); border-radius: 20px; padding: 8px 16px; }
  .hero-score-label { color: rgba(255,255,255,0.85); font-size: 13px; }
  .hero-score-value { color: #fff; font-weight: 700; font-size: 16px; }
  .stars { display: flex; gap: 2px; }
  .star { font-size: 11px; }
  .mascots-row { position: absolute; right: 16px; bottom: 16px; display: flex; z-index: 3; }
  .mascot { width: 52px; height: 52px; filter: drop-shadow(0 4px 8px rgba(0,0,0,0.15)); animation: float 3s ease-in-out infinite; }
  .mascot:nth-child(2) { animation-delay: 0.5s; margin-left: -8px; margin-top: -6px; }
  .mascot:nth-child(3) { animation-delay: 1s; margin-left: -6px; margin-top: 4px; }
  @keyframes float { 0%,100% { transform: translateY(0) rotate(0deg); } 50% { transform: translateY(-6px) rotate(3deg); } }

  /* COMPANIONS */
  .companions-section { position: relative; z-index: 5; padding: 24px 24px 0; }
  .section-label { font-size: 11px; text-transform: uppercase; letter-spacing: 2px; color: var(--text-light); margin-bottom: 12px; font-weight: 500; }
  .companions-scroll { display: flex; gap: 12px; overflow-x: auto; padding-bottom: 4px; scrollbar-width: none; }
  .companion-chip { flex-shrink: 0; display: flex; flex-direction: column; align-items: center; gap: 6px; cursor: pointer; transition: transform 0.2s; }
  .companion-chip:hover { transform: translateY(-3px); }
  .companion-avatar { width: 56px; height: 56px; border-radius: 18px; display: flex; align-items: center; justify-content: center; border: 2px solid transparent; transition: all 0.2s; }
  .companion-avatar.active { border-color: var(--terracotta); box-shadow: 0 0 0 3px rgba(196,113,74,0.15); }
  .companion-avatar svg { width: 40px; height: 40px; }
  .companion-name { font-size: 11px; color: var(--mid-brown); text-align: center; font-weight: 500; }

  /* TIMELINE */
  .plan-section { position: relative; z-index: 5; padding: 28px 24px; }
  .timeline { display: flex; flex-direction: column; gap: 16px; }
  .moment-card { background: var(--warm-white); border-radius: 24px; padding: 20px; border: 1.5px solid rgba(196,113,74,0.1); box-shadow: 0 4px 20px rgba(61,43,31,0.06); position: relative; overflow: hidden; transition: transform 0.2s, box-shadow 0.2s; cursor: pointer; animation: fadeSlideIn 0.5s ease both; }
  .moment-card:hover { transform: translateY(-2px); box-shadow: 0 8px 30px rgba(61,43,31,0.12); }
  .moment-card:nth-child(1) { animation-delay: 0.1s; }
  .moment-card:nth-child(2) { animation-delay: 0.2s; }
  .moment-card:nth-child(3) { animation-delay: 0.3s; }
  .moment-card:nth-child(4) { animation-delay: 0.4s; }
  .moment-card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; border-radius: 4px 0 0 4px; }
  .moment-card.matin::before { background: var(--golden); }
  .moment-card.midi::before { background: var(--terracotta); }
  .moment-card.apres-midi::before { background: var(--sage); }
  .moment-card.soir::before { background: var(--mirtille-purple); }
  .moment-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
  .moment-time-block { display: flex; align-items: center; gap: 8px; }
  .moment-emoji { font-size: 24px; line-height: 1; }
  .moment-time { font-size: 11px; color: var(--text-light); font-weight: 500; text-transform: uppercase; letter-spacing: 1px; }
  .moment-label { font-family: 'Fraunces', serif; font-size: 13px; font-weight: 500; color: var(--mid-brown); }
  .moment-calories { background: var(--cream); border-radius: 10px; padding: 4px 10px; font-size: 12px; color: var(--text-light); font-weight: 500; }
  .moment-title { font-family: 'Fraunces', serif; font-size: 18px; font-weight: 700; color: var(--deep-brown); line-height: 1.3; margin-bottom: 6px; }
  .moment-description { font-size: 14px; color: var(--mid-brown); line-height: 1.5; margin-bottom: 12px; }
  .moment-footer { display: flex; justify-content: space-between; align-items: center; }
  .moment-motivant { font-size: 13px; color: var(--terracotta); font-style: italic; font-weight: 500; flex: 1; }
  .expand-btn { width: 32px; height: 32px; background: var(--cream); border-radius: 10px; display: flex; align-items: center; justify-content: center; border: none; cursor: pointer; font-size: 14px; color: var(--mid-brown); transition: background 0.2s; flex-shrink: 0; }
  .expand-btn:hover { background: var(--peach); }
  .moment-instructions { max-height: 0; overflow: hidden; transition: max-height 0.4s ease; }
  .moment-instructions.open { max-height: 900px; }
  .instructions-content { margin-top: 14px; padding-top: 14px; border-top: 1px dashed rgba(196,113,74,0.2); font-size: 13.5px; color: var(--mid-brown); line-height: 1.6; }
  .instructions-steps { display: flex; flex-direction: column; gap: 10px; margin-bottom: 12px; }
  .instruction-step { display: flex; gap: 10px; align-items: flex-start; }
  .step-num { width: 22px; height: 22px; background: var(--terracotta); color: white; border-radius: 50%; font-size: 11px; font-weight: 700; display: flex; align-items: center; justify-content: center; flex-shrink: 0; margin-top: 1px; }
  .step-text { font-size: 13px; color: var(--mid-brown); line-height: 1.55; }
  .instructions-tip { background: rgba(232,184,75,0.12); border-left: 3px solid var(--golden); border-radius: 0 8px 8px 0; padding: 8px 12px; font-size: 12.5px; color: var(--mid-brown); font-style: italic; margin-top: 4px; }
  .instructions-ingredients { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 12px; }
  .ingredient-tag { background: var(--cream); border: 1px solid rgba(196,113,74,0.18); border-radius: 20px; padding: 3px 10px; font-size: 12px; color: var(--mid-brown); }
  .instructions-section-label { font-size: 10px; text-transform: uppercase; letter-spacing: 1.5px; color: var(--text-light); font-weight: 600; margin-bottom: 7px; }

  /* RECIPE ACTIONS BAR */
  .recipe-actions { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px; margin-top: 14px; padding-top: 12px; border-top: 1px dashed rgba(196,113,74,0.2); }
  .servings-stepper { display: flex; align-items: center; gap: 8px; background: var(--cream); border-radius: 20px; padding: 5px 10px; border: 1px solid rgba(196,113,74,0.15); }
  .servings-label { font-size: 11px; color: var(--text-light); font-weight: 500; white-space: nowrap; }
  .stepper-btn { width: 24px; height: 24px; background: var(--terracotta); color: white; border: none; border-radius: 50%; cursor: pointer; font-size: 16px; font-weight: 700; display: flex; align-items: center; justify-content: center; transition: background 0.2s; flex-shrink: 0; font-family: 'DM Sans', sans-serif; line-height: 1; padding-bottom: 1px; }
  .stepper-btn:hover { background: var(--dusty-rose); }
  .stepper-count { font-size: 14px; font-weight: 600; color: var(--deep-brown); min-width: 18px; text-align: center; }
  .recipe-rating { display: flex; align-items: center; gap: 5px; }
  .recipe-rating-label { font-size: 11px; color: var(--text-light); font-weight: 500; }
  .recipe-stars { display: flex; gap: 2px; }
  .recipe-star { font-size: 18px; cursor: pointer; transition: transform 0.15s; filter: grayscale(1) opacity(0.3); user-select: none; }
  .recipe-star:hover, .recipe-star.lit { filter: none; transform: scale(1.25); }
  .save-recipe-btn { background: var(--warm-white); border: 1.5px solid rgba(196,113,74,0.25); border-radius: 20px; padding: 5px 12px; font-size: 12px; color: var(--mid-brown); cursor: pointer; font-family: 'DM Sans', sans-serif; font-weight: 500; transition: all 0.2s; display: flex; align-items: center; gap: 5px; }
  .save-recipe-btn:hover { background: var(--peach); border-color: var(--terracotta); }
  .save-recipe-btn.saved { background: rgba(196,113,74,0.1); border-color: var(--terracotta); color: var(--terracotta); }

  /* ROUTINE */
  .routine-section { position: relative; z-index: 5; padding: 0 24px 20px; }
  .routine-card { background: linear-gradient(135deg, rgba(122,158,126,0.15) 0%, rgba(168,197,172,0.1) 100%); border: 1.5px solid rgba(122,158,126,0.25); border-radius: 24px; padding: 20px; }
  .routine-title { font-family: 'Fraunces', serif; font-size: 16px; font-weight: 700; color: var(--deep-brown); margin-bottom: 14px; display: flex; align-items: center; gap: 8px; }
  .routine-items { display: flex; flex-direction: column; gap: 10px; }
  .routine-item { display: flex; align-items: flex-start; gap: 10px; }
  .routine-dot { width: 8px; height: 8px; background: var(--sage); border-radius: 50%; margin-top: 6px; flex-shrink: 0; }
  .routine-text { font-size: 14px; color: var(--mid-brown); line-height: 1.4; }
  .routine-text strong { color: var(--deep-brown); font-weight: 600; }

  /* CONSEIL */
  .conseil-section { position: relative; z-index: 5; padding: 0 24px 32px; }
  .conseil-card { background: var(--warm-white); border-radius: 24px; padding: 20px; border: 1.5px solid rgba(232,184,75,0.2); position: relative; overflow: hidden; }
  .conseil-card::before { content: '"'; position: absolute; top: -10px; left: 12px; font-family: 'Fraunces', serif; font-size: 100px; color: rgba(232,184,75,0.12); line-height: 1; }
  .conseil-title { font-size: 11px; text-transform: uppercase; letter-spacing: 2px; color: var(--golden); font-weight: 600; margin-bottom: 10px; }
  .conseil-text { font-family: 'Fraunces', serif; font-size: 15px; font-style: italic; color: var(--mid-brown); line-height: 1.6; position: relative; z-index: 1; }

  /* LOADING */
  .loading-screen { position: fixed; inset: 0; background: var(--cream); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; gap: 24px; transition: opacity 0.4s; }
  .loading-mascot { animation: spin-bounce 1.5s ease-in-out infinite; }
  @keyframes spin-bounce { 0%,100% { transform: scale(1) rotate(0deg); } 25% { transform: scale(1.1) rotate(5deg); } 75% { transform: scale(0.9) rotate(-5deg); } }
  .loading-text { font-family: 'Fraunces', serif; font-size: 20px; color: var(--deep-brown); text-align: center; }
  .loading-sub { font-size: 14px; color: var(--text-light); text-align: center; max-width: 260px; line-height: 1.5; }
  .loading-dots { display: flex; gap: 6px; }
  .loading-dot { width: 8px; height: 8px; background: var(--terracotta); border-radius: 50%; animation: dot-bounce 1.2s ease-in-out infinite; }
  .loading-dot:nth-child(2) { animation-delay: 0.2s; background: var(--sage); }
  .loading-dot:nth-child(3) { animation-delay: 0.4s; background: var(--golden); }
  @keyframes dot-bounce { 0%,100% { transform: translateY(0); opacity: 0.5; } 50% { transform: translateY(-8px); opacity: 1; } }

  /* GENERATE BTN */
  .generate-btn { position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%); z-index: 20; background: linear-gradient(135deg, var(--terracotta), var(--dusty-rose)); color: white; border: none; border-radius: 30px; padding: 16px 40px; font-family: 'DM Sans', sans-serif; font-size: 16px; font-weight: 600; cursor: pointer; box-shadow: 0 8px 30px rgba(196,113,74,0.35); transition: all 0.3s; white-space: nowrap; display: flex; align-items: center; gap: 10px; }
  .generate-btn:hover { transform: translateX(-50%) translateY(-2px); box-shadow: 0 12px 40px rgba(196,113,74,0.45); }

  /* CONFIG PANEL */
  .config-panel { position: fixed; bottom: 0; left: 0; right: 0; background: var(--warm-white); border-radius: 28px 28px 0 0; padding: 28px 24px 40px; z-index: 50; transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.32,0.72,0,1); box-shadow: 0 -8px 40px rgba(61,43,31,0.12); }
  .config-panel.open { transform: translateY(0); }
  .config-handle { width: 36px; height: 4px; background: var(--peach); border-radius: 2px; margin: 0 auto 20px; }
  .config-title { font-family: 'Fraunces', serif; font-size: 20px; font-weight: 700; color: var(--deep-brown); margin-bottom: 20px; }
  .config-field { margin-bottom: 16px; }
  .config-label { font-size: 12px; text-transform: uppercase; letter-spacing: 1.5px; color: var(--text-light); font-weight: 600; margin-bottom: 8px; display: block; }
  .config-input { width: 100%; background: var(--cream); border: 1.5px solid rgba(196,113,74,0.15); border-radius: 14px; padding: 12px 16px; font-family: 'DM Sans', sans-serif; font-size: 14px; color: var(--deep-brown); outline: none; }
  .config-input:focus { border-color: var(--terracotta); }
  .config-row { display: flex; gap: 12px; }
  .config-row .config-field { flex: 1; }
  .config-chips { display: flex; flex-wrap: wrap; gap: 8px; }
  .config-chip { background: var(--cream); border: 1.5px solid rgba(196,113,74,0.15); border-radius: 20px; padding: 6px 14px; font-size: 13px; color: var(--mid-brown); cursor: pointer; transition: all 0.2s; font-family: 'DM Sans', sans-serif; }
  .config-chip.selected { background: var(--terracotta); border-color: var(--terracotta); color: white; }
  .config-submit { width: 100%; margin-top: 20px; background: linear-gradient(135deg, var(--terracotta), var(--dusty-rose)); color: white; border: none; border-radius: 16px; padding: 16px; font-family: 'DM Sans', sans-serif; font-size: 16px; font-weight: 600; cursor: pointer; }

  .overlay { position: fixed; inset: 0; background: rgba(61,43,31,0.3); z-index: 40; opacity: 0; pointer-events: none; transition: opacity 0.3s; backdrop-filter: blur(2px); }
  .overlay.active { opacity: 1; pointer-events: all; }

  /* FEEDBACK */
  .feedback-bar { margin: 0 24px 24px; background: linear-gradient(135deg, rgba(196,113,74,0.07), rgba(232,184,75,0.07)); border: 1.5px solid rgba(196,113,74,0.18); border-radius: 20px; padding: 18px 20px; display: flex; align-items: center; justify-content: space-between; gap: 12px; }
  .feedback-label { font-size: 13px; color: var(--mid-brown); flex-shrink: 0; font-weight: 500; }
  .feedback-stars { display: flex; gap: 6px; }
  .feedback-star { font-size: 24px; cursor: pointer; transition: transform 0.15s; filter: grayscale(1) opacity(0.35); user-select: none; }
  .feedback-star:hover, .feedback-star.lit { filter: none; transform: scale(1.2); }
  .feedback-sent { font-size: 13px; color: var(--sage); font-weight: 600; display: none; }
  .feedback-sent.show { display: block; }

  /* TOAST */
  .toast { position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%) translateY(80px); background: var(--deep-brown); color: white; border-radius: 14px; padding: 12px 20px; font-size: 14px; box-shadow: 0 8px 24px rgba(61,43,31,0.25); transition: transform 0.35s cubic-bezier(0.34,1.56,0.64,1); z-index: 200; white-space: nowrap; }
  .toast.show { transform: translateX(-50%) translateY(-80px); }

  .scroll-pad { height: 100px; }
  @keyframes fadeSlideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
</style>
</head>
<body>

<svg style="display:none" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <symbol id="mascot-goji" viewBox="0 0 80 80">
      <ellipse cx="40" cy="48" rx="22" ry="24" fill="#C0392B"/><ellipse cx="40" cy="46" rx="20" ry="22" fill="#E74C3C"/>
      <ellipse cx="33" cy="38" rx="6" ry="4" fill="rgba(255,255,255,0.3)" transform="rotate(-20 33 38)"/>
      <ellipse cx="28" cy="27" rx="8" ry="4" fill="#27AE60" transform="rotate(-30 28 27)"/>
      <ellipse cx="52" cy="26" rx="8" ry="4" fill="#2ECC71" transform="rotate(30 52 26)"/>
      <rect x="38" y="22" width="4" height="8" rx="2" fill="#8B6914"/>
      <circle cx="34" cy="47" r="3.5" fill="#000" opacity="0.7"/><circle cx="46" cy="47" r="3.5" fill="#000" opacity="0.7"/>
      <circle cx="35" cy="46" r="1.2" fill="white"/><circle cx="47" cy="46" r="1.2" fill="white"/>
      <path d="M34 55 Q40 61 46 55" stroke="#8B0000" stroke-width="2" fill="none" stroke-linecap="round"/>
      <circle cx="28" cy="51" r="4" fill="rgba(255,180,180,0.5)"/><circle cx="52" cy="51" r="4" fill="rgba(255,180,180,0.5)"/>
      <path d="M20 52 L18 70 L40 64 L62 70 L60 52 Q40 60 20 52Z" fill="#8B0000" opacity="0.8"/>
    </symbol>
    <symbol id="mascot-curcuma" viewBox="0 0 80 80">
      <ellipse cx="40" cy="50" rx="18" ry="20" fill="#E67E22"/><ellipse cx="40" cy="48" rx="16" ry="18" fill="#F39C12"/>
      <ellipse cx="56" cy="52" rx="10" ry="8" fill="#E67E22"/><ellipse cx="24" cy="55" rx="9" ry="7" fill="#E67E22"/>
      <ellipse cx="40" cy="33" rx="20" ry="6" fill="#8B6914"/><rect x="28" y="20" width="24" height="14" rx="4" fill="#6B4F0A"/>
      <rect x="30" y="22" width="20" height="10" rx="3" fill="#8B6914"/>
      <circle cx="35" cy="46" r="3" fill="#000" opacity="0.7"/><circle cx="45" cy="46" r="3" fill="#000" opacity="0.7"/>
      <circle cx="36" cy="45" r="1" fill="white"/><circle cx="46" cy="45" r="1" fill="white"/>
      <path d="M31 41 Q35 39 38 41" stroke="#7D5A00" stroke-width="2" fill="none" stroke-linecap="round"/>
      <path d="M42 41 Q45 39 49 41" stroke="#7D5A00" stroke-width="2" fill="none" stroke-linecap="round"/>
      <path d="M33 53 Q40 58 47 53" stroke="#7D5A00" stroke-width="2" fill="none" stroke-linecap="round"/>
      <path d="M33 57 Q40 65 47 57" stroke="#D4A017" stroke-width="3" fill="none" stroke-linecap="round"/>
    </symbol>
    <symbol id="mascot-gingembre" viewBox="0 0 80 80">
      <ellipse cx="40" cy="50" rx="16" ry="18" fill="#CA8A04"/><ellipse cx="40" cy="48" rx="14" ry="16" fill="#D97706"/>
      <ellipse cx="58" cy="44" rx="11" ry="8" fill="#CA8A04" transform="rotate(20 58 44)"/>
      <ellipse cx="22" cy="42" rx="11" ry="8" fill="#CA8A04" transform="rotate(-20 22 42)"/>
      <path d="M60 20 Q63 12 58 8 Q65 14 64 20 Q67 13 63 8 Q70 16 66 22Z" fill="#EF4444" opacity="0.8"/>
      <circle cx="35" cy="47" r="3" fill="#000" opacity="0.7"/><circle cx="45" cy="47" r="3" fill="#000" opacity="0.7"/>
      <circle cx="36" cy="46" r="1" fill="white"/><circle cx="46" cy="46" r="1" fill="white"/>
      <path d="M33 54 Q40 60 47 54" stroke="#92400E" stroke-width="2" fill="#FCA5A5" stroke-linecap="round"/>
      <text x="8" y="35" font-size="12" fill="#F59E0B">&#x26A1;</text>
    </symbol>
    <symbol id="mascot-myrtille" viewBox="0 0 80 80">
      <circle cx="40" cy="50" r="22" fill="#7C3AED"/><circle cx="40" cy="48" r="20" fill="#8B5CF6"/>
      <ellipse cx="33" cy="40" rx="6" ry="4" fill="rgba(255,255,255,0.25)" transform="rotate(-15 33 40)"/>
      <circle cx="40" cy="28" r="5" fill="#6D28D9"/><circle cx="33" cy="30" r="4" fill="#7C3AED"/><circle cx="47" cy="30" r="4" fill="#7C3AED"/>
      <circle cx="34" cy="46" r="7" fill="none" stroke="#C4B5FD" stroke-width="2"/>
      <circle cx="46" cy="46" r="7" fill="none" stroke="#C4B5FD" stroke-width="2"/>
      <line x1="41" y1="46" x2="39" y2="46" stroke="#C4B5FD" stroke-width="2"/>
      <circle cx="34" cy="46" r="3" fill="#1E1B4B" opacity="0.8"/><circle cx="46" cy="46" r="3" fill="#1E1B4B" opacity="0.8"/>
      <circle cx="35" cy="45" r="1" fill="white"/><circle cx="47" cy="45" r="1" fill="white"/>
      <path d="M34 56 Q40 62 46 56" stroke="#4C1D95" stroke-width="2.5" fill="none" stroke-linecap="round"/>
      <circle cx="27" cy="53" r="4" fill="rgba(196,181,253,0.4)"/><circle cx="53" cy="53" r="4" fill="rgba(196,181,253,0.4)"/>
    </symbol>
    <symbol id="mascot-avocat" viewBox="0 0 80 80">
      <ellipse cx="40" cy="50" rx="20" ry="26" fill="#166534"/><ellipse cx="40" cy="52" rx="18" ry="24" fill="#16A34A"/>
      <ellipse cx="40" cy="55" rx="13" ry="17" fill="#BBF7D0"/><ellipse cx="40" cy="57" rx="10" ry="13" fill="#86EFAC"/>
      <ellipse cx="40" cy="60" rx="7" ry="9" fill="#92400E"/>
      <rect x="26" y="40" width="12" height="8" rx="4" fill="#0F172A"/><rect x="42" y="40" width="12" height="8" rx="4" fill="#0F172A"/>
      <line x1="38" y1="44" x2="42" y2="44" stroke="#334155" stroke-width="2"/>
      <path d="M33 55 Q40 61 47 55" stroke="#14532D" stroke-width="2.5" fill="none" stroke-linecap="round"/>
      <rect x="38" y="22" width="4" height="10" rx="2" fill="#166534"/>
    </symbol>
  </defs>
</svg>

<!-- LOADING -->
<div class="loading-screen" id="loadingScreen">
  <div class="loading-mascot"><svg width="90" height="90"><use href="#mascot-goji"/></svg></div>
  <div class="loading-text" id="loadingText">Vitalia pr√©pare ton plan ‚ú®</div>
  <div class="loading-sub">Nos super-aliments analysent tes besoins...</div>
  <div class="loading-dots"><div class="loading-dot"></div><div class="loading-dot"></div><div class="loading-dot"></div></div>
</div>

<!-- OVERLAY -->
<div class="overlay" id="overlay" onclick="fermerTout()"></div>

<!-- SAVED PANEL -->
<div class="saved-panel" id="savedPanel">
  <div class="saved-panel-header">
    <div class="saved-panel-title">üîñ Recettes sauvegard√©es</div>
    <button class="saved-panel-close" onclick="fermerSauvegardees()">‚úï</button>
  </div>
  <div class="saved-list" id="savedList">
    <div class="saved-empty"><div class="saved-empty-icon">üçÉ</div><div>Aucune recette sauvegard√©e.<br>Ouvre une recette et clique sur Sauvegarder !</div></div>
  </div>
</div>

<!-- CONFIG PANEL -->
<div class="config-panel" id="configPanel">
  <div class="config-handle"></div>
  <div class="config-title">üåø Personnalise ton plan</div>
  <div class="config-field">
    <label class="config-label">Comment tu te sens ?</label>
    <div class="config-chips" id="symptomsChips">
      <div class="config-chip selected" onclick="toggleChip(this,'fatigue')">üò¥ Fatigue</div>
      <div class="config-chip selected" onclick="toggleChip(this,'stress')">üò∞ Stress</div>
      <div class="config-chip" onclick="toggleChip(this,'digestion')">üåÄ Digestion</div>
      <div class="config-chip" onclick="toggleChip(this,'sommeil')">üåô Sommeil</div>
      <div class="config-chip" onclick="toggleChip(this,'inflammation')">üî• Inflammation</div>
      <div class="config-chip" onclick="toggleChip(this,'energie')">‚ö° √ânergie</div>
    </div>
  </div>
  <div class="config-row">
    <div class="config-field">
      <label class="config-label">Temps max</label>
      <select class="config-input" id="tempsMax"><option value="15">15 min</option><option value="30" selected>30 min</option><option value="45">45 min</option><option value="60">1h</option></select>
    </div>
    <div class="config-field">
      <label class="config-label">Budget/jour</label>
      <select class="config-input" id="budgetMax"><option value="10">10‚Ç¨</option><option value="15" selected>15‚Ç¨</option><option value="25">25‚Ç¨</option></select>
    </div>
  </div>
  <div class="config-field">
    <label class="config-label">R√©gimes</label>
    <div class="config-chips">
      <div class="config-chip selected" onclick="toggleChip(this,'sans_gluten')" data-regime="sans_gluten">üåæ Sans gluten</div>
      <div class="config-chip" onclick="toggleChip(this,'vegan')" data-regime="vegan">üå± V√©gan</div>
      <div class="config-chip" onclick="toggleChip(this,'sans_lactose')" data-regime="sans_lactose">ü•õ Sans lactose</div>
      <div class="config-chip" onclick="toggleChip(this,'keto')" data-regime="keto">ü•ë K√©to</div>
    </div>
  </div>
  <button class="config-submit" onclick="genererPlan()">‚ú® G√©n√©rer mon plan</button>
</div>

<!-- APP -->
<div id="app" style="opacity:0;transition:opacity 0.5s;">
  <div class="toast" id="toast"></div>

  <div class="header">
    <div class="logo">Vita<span>lia</span></div>
    <div class="header-actions">
      <button class="bookmark-btn" onclick="ouvrirSauvegardees()">üîñ <span id="savedCount">0</span></button>
      <div class="date-badge" id="dateBadge">Vendredi 20 f√©v.</div>
    </div>
  </div>

  <div class="hero">
    <div class="hero-card">
      <div class="hero-greeting">Ton plan du jour</div>
      <div class="hero-message" id="heroMessage">Bonjour ! Pr√™t √† prendre soin de toi ? üåø</div>
      <div class="hero-score">
        <span class="hero-score-label">Score nutritionnel</span>
        <span class="hero-score-value" id="scoreValue">8/10</span>
        <div class="stars" id="starsContainer"></div>
      </div>
      <div class="mascots-row">
        <svg class="mascot"><use href="#mascot-goji"/></svg>
        <svg class="mascot"><use href="#mascot-curcuma"/></svg>
        <svg class="mascot"><use href="#mascot-gingembre"/></svg>
      </div>
    </div>
  </div>

  <div class="companions-section">
    <div class="section-label">Tes alli√©s du jour</div>
    <div class="companions-scroll">
      <div class="companion-chip"><div class="companion-avatar active" style="background:linear-gradient(135deg,#FEE2E2,#FECACA)"><svg><use href="#mascot-goji"/></svg></div><div class="companion-name">Goji</div></div>
      <div class="companion-chip"><div class="companion-avatar" style="background:linear-gradient(135deg,#FEF3C7,#FDE68A)"><svg><use href="#mascot-curcuma"/></svg></div><div class="companion-name">Curcuma</div></div>
      <div class="companion-chip"><div class="companion-avatar" style="background:linear-gradient(135deg,#FFF7ED,#FED7AA)"><svg><use href="#mascot-gingembre"/></svg></div><div class="companion-name">Gingembre</div></div>
      <div class="companion-chip"><div class="companion-avatar" style="background:linear-gradient(135deg,#EDE9FE,#DDD6FE)"><svg><use href="#mascot-myrtille"/></svg></div><div class="companion-name">Myrtille</div></div>
      <div class="companion-chip"><div class="companion-avatar" style="background:linear-gradient(135deg,#DCFCE7,#BBF7D0)"><svg><use href="#mascot-avocat"/></svg></div><div class="companion-name">Avocat</div></div>
    </div>
  </div>

  <div class="plan-section">
    <div class="section-label">Ton programme</div>
    <div class="timeline" id="timeline">

      <div class="moment-card matin" onclick="toggleInstructions('matin',event)">
        <div class="moment-header"><div class="moment-time-block"><div class="moment-emoji">üåÖ</div><div><div class="moment-time" id="matin-time">7h30</div><div class="moment-label">Petit-d√©jeuner</div></div></div><div class="moment-calories" id="matin-cal">350 kcal</div></div>
        <div class="moment-title" id="matin-titre">Bol √ânergie Matinale au Curcuma Dor√©</div>
        <div class="moment-description" id="matin-desc">Un porridge cr√©meux sans gluten au lait d'amande, parfum√© au curcuma pour un r√©veil tout en douceur.</div>
        <div class="moment-footer"><div class="moment-motivant" id="matin-motivant">Une cuill√®re d'or pour bien d√©marrer ! ‚ú®</div><button class="expand-btn" id="btn-matin">‚ñº</button></div>
        <div class="moment-instructions" id="instructions-matin">
          <div class="instructions-content" id="matin-instructions">
            <div class="instructions-section-label">Ingr√©dients</div>
            <div class="instructions-ingredients" id="ing-matin"><span class="ingredient-tag">40g flocons sarrasin</span><span class="ingredient-tag">200ml lait d'amande</span><span class="ingredient-tag">1/2 c.a.c curcuma</span><span class="ingredient-tag">1 pinc√©e cannelle</span><span class="ingredient-tag">20g amandes effil√©es</span><span class="ingredient-tag">1 c.a.c miel</span></div>
            <div class="instructions-section-label">Pr√©paration</div>
            <div class="instructions-steps">
              <div class="instruction-step"><div class="step-num">1</div><div class="step-text">Faire chauffer le lait d'amande √† feu moyen. D√®s les premiers fr√©missements, ajouter les flocons de sarrasin.</div></div>
              <div class="instruction-step"><div class="step-num">2</div><div class="step-text">Incorporer le curcuma et la cannelle. R√©duire le feu, laisser gonfler 4-5 min en remuant jusqu'√† texture cr√©meuse.</div></div>
              <div class="instruction-step"><div class="step-num">3</div><div class="step-text">Verser dans un bol, parsemer d'amandes effil√©es et d'un filet de miel. D√©guster chaud.</div></div>
            </div>
            <div class="instructions-tip"><strong>Astuce :</strong> Le curcuma s'absorbe mieux avec des mati√®res grasses (pr√©sentes dans les amandes). La cannelle potentialise ses effets anti-inflammatoires.</div>
          </div>
        </div>
      </div>

      <div class="moment-card midi" onclick="toggleInstructions('midi',event)">
        <div class="moment-header"><div class="moment-time-block"><div class="moment-emoji">‚òÄÔ∏è</div><div><div class="moment-time" id="midi-time">12h30</div><div class="moment-label">D√©jeuner</div></div></div><div class="moment-calories" id="midi-cal">550 kcal</div></div>
        <div class="moment-title" id="midi-titre">Bowl R√©confort Lentilles & Potimarron R√¥ti</div>
        <div class="moment-description" id="midi-desc">Lentilles corail, potimarron r√¥ti au romarin et √©pinards frais, arros√©s d'une vinaigrette citron-gingembre.</div>
        <div class="moment-footer"><div class="moment-motivant" id="midi-motivant">Ce bol est une vraie caresse pour tes papilles üíõ</div><button class="expand-btn" id="btn-midi">‚ñº</button></div>
        <div class="moment-instructions" id="instructions-midi">
          <div class="instructions-content" id="midi-instructions">
            <div class="instructions-section-label">Ingr√©dients</div>
            <div class="instructions-ingredients" id="ing-midi"><span class="ingredient-tag">60g lentilles corail</span><span class="ingredient-tag">150g potimarron</span><span class="ingredient-tag">1 poign√©e √©pinards</span><span class="ingredient-tag">2 c.a.s huile d'olive</span><span class="ingredient-tag">Jus 1/2 citron</span><span class="ingredient-tag">1 c.a.c gingembre r√¢p√©</span></div>
            <div class="instructions-section-label">Pr√©paration</div>
            <div class="instructions-steps">
              <div class="instruction-step"><div class="step-num">1</div><div class="step-text">Pr√©chauffer le four √† 200¬∞. Couper le potimarron en cubes, enfourner avec huile et romarin pendant 20 min.</div></div>
              <div class="instruction-step"><div class="step-num">2</div><div class="step-text">Rincer les lentilles corail, cuire 10-12 min dans 2x leur volume d'eau sal√©e. √âgoutter.</div></div>
              <div class="instruction-step"><div class="step-num">3</div><div class="step-text">M√©langer huile d'olive, jus de citron et gingembre r√¢p√© pour la vinaigrette.</div></div>
              <div class="instruction-step"><div class="step-num">4</div><div class="step-text">Assembler √©pinards, lentilles et potimarron dans un bol. Arroser de vinaigrette.</div></div>
            </div>
            <div class="instructions-tip"><strong>Astuce :</strong> La vitamine C du citron multiplie par 3 l'absorption du fer v√©g√©tal des l√©gumineuses.</div>
          </div>
        </div>
      </div>

      <div class="moment-card apres-midi" onclick="toggleInstructions('apres_midi',event)">
        <div class="moment-header"><div class="moment-time-block"><div class="moment-emoji">üçÉ</div><div><div class="moment-time" id="apres_midi-time">15h30</div><div class="moment-label">Pause</div></div></div><div class="moment-calories" id="apres_midi-cal">150 kcal</div></div>
        <div class="moment-title" id="apres_midi-titre">Pause Douceur & Coh√©rence Cardiaque</div>
        <div class="moment-description" id="apres_midi-desc">Chocolat noir 70% + tisane au thym + 5 minutes de coh√©rence cardiaque pour recentrer ton √©nergie.</div>
        <div class="moment-footer"><div class="moment-motivant" id="apres_midi-motivant">Prends ce moment rien que pour toi üôè</div><button class="expand-btn" id="btn-apres_midi">‚ñº</button></div>
        <div class="moment-instructions" id="instructions-apres_midi">
          <div class="instructions-content" id="apres_midi-instructions">
            <div class="instructions-section-label">Ingr√©dients</div>
            <div class="instructions-ingredients" id="ing-apres_midi"><span class="ingredient-tag">1 carr√© chocolat noir 70%+</span><span class="ingredient-tag">250ml eau bouillante</span><span class="ingredient-tag">1 sachet thym bio</span></div>
            <div class="instructions-section-label">Pr√©paration</div>
            <div class="instructions-steps">
              <div class="instruction-step"><div class="step-num">1</div><div class="step-text">Verser l'eau bouillante sur le sachet de thym, couvrir et laisser infuser 5 min.</div></div>
              <div class="instruction-step"><div class="step-num">2</div><div class="step-text">Pratiquer la coh√©rence cardiaque : inspirer 5s, expirer 5s, pendant 5 minutes.</div></div>
              <div class="instruction-step"><div class="step-num">3</div><div class="step-text">D√©guster le carr√© de chocolat en le laissant fondre lentement sur la langue.</div></div>
            </div>
            <div class="instructions-tip"><strong>Astuce :</strong> Le chocolat noir >70% contient 64mg de magn√©sium par carr√©. La coh√©rence cardiaque r√©duit le cortisol de ~20% en 5 min.</div>
          </div>
        </div>
      </div>

      <div class="moment-card soir" onclick="toggleInstructions('soir',event)">
        <div class="moment-header"><div class="moment-time-block"><div class="moment-emoji">üåô</div><div><div class="moment-time" id="soir-time">19h30</div><div class="moment-label">D√Æner</div></div></div><div class="moment-calories" id="soir-cal">450 kcal</div></div>
        <div class="moment-title" id="soir-titre">Velout√© Cocon Patate Douce & Pois Chiches Croquants</div>
        <div class="moment-description" id="soir-desc">Soupe onctueuse √† la patate douce et lait de coco, agr√©ment√©e de pois chiches r√¥tis aux √©pices.</div>
        <div class="moment-footer"><div class="moment-motivant" id="soir-motivant">Un d√Æner l√©ger pour une nuit r√©paratrice üåô</div><button class="expand-btn" id="btn-soir">‚ñº</button></div>
        <div class="moment-instructions" id="instructions-soir">
          <div class="instructions-content" id="soir-instructions">
            <div class="instructions-section-label">Ingr√©dients</div>
            <div class="instructions-ingredients" id="ing-soir"><span class="ingredient-tag">300g patate douce</span><span class="ingredient-tag">1 oignon</span><span class="ingredient-tag">50ml lait de coco</span><span class="ingredient-tag">1 bo√Æte pois chiches</span><span class="ingredient-tag">1 c.a.c paprika fum√©</span><span class="ingredient-tag">1 c.a.c cumin</span></div>
            <div class="instructions-section-label">Pr√©paration</div>
            <div class="instructions-steps">
              <div class="instruction-step"><div class="step-num">1</div><div class="step-text">Pr√©chauffer le four √† 200¬∞. √âgoutter les pois chiches, √©taler avec huile, paprika et cumin. Enfourner 15-20 min.</div></div>
              <div class="instruction-step"><div class="step-num">2</div><div class="step-text">Faire revenir l'oignon √©minc√© 3 min, ajouter la patate douce en cubes, couvrir d'eau. Cuire 15 min.</div></div>
              <div class="instruction-step"><div class="step-num">3</div><div class="step-text">Mixer avec le lait de coco jusqu'√† velout√© lisse. Assaisonner et servir avec les pois chiches croustillants.</div></div>
            </div>
            <div class="instructions-tip"><strong>Astuce :</strong> La patate douce est riche en tryptophane, pr√©curseur de la m√©latonine ‚Äî parfaite le soir pour un endormissement serein.</div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <div class="feedback-bar" id="feedbackBar" style="display:none">
    <div><div class="feedback-label">Ce plan te convient ?</div><div style="font-size:11px;color:var(--text-light);margin-top:2px">Ta note nous aide √† am√©liorer tes prochains plans</div></div>
    <div class="feedback-stars" id="feedbackStars">
      <span class="feedback-star" onclick="noterPlan(1)">‚≠ê</span><span class="feedback-star" onclick="noterPlan(2)">‚≠ê</span><span class="feedback-star" onclick="noterPlan(3)">‚≠ê</span><span class="feedback-star" onclick="noterPlan(4)">‚≠ê</span><span class="feedback-star" onclick="noterPlan(5)">‚≠ê</span>
    </div>
    <span class="feedback-sent" id="feedbackSent">Merci ! üôè</span>
  </div>

  <div class="routine-section">
    <div class="routine-card">
      <div class="routine-title">üßò Routine du jour</div>
      <div class="routine-items">
        <div class="routine-item"><div class="routine-dot"></div><div class="routine-text"><strong>Matin :</strong> <span id="routine-matin">5 minutes de coh√©rence cardiaque</span></div></div>
        <div class="routine-item"><div class="routine-dot" style="background:var(--terracotta)"></div><div class="routine-text"><strong>Compl√©ment phare :</strong> <span id="routine-complement">Vitamine D ‚Äî 1 goutte ce midi avec ton repas</span></div></div>
        <div class="routine-item"><div class="routine-dot" style="background:var(--golden)"></div><div class="routine-text"><strong>Aromath√©rapie :</strong> <span id="routine-aroma">Diffusion lavande le soir pour pr√©parer le sommeil</span></div></div>
        <div class="routine-item"><div class="routine-dot" style="background:var(--mirtille-purple)"></div><div class="routine-text"><strong>Soir :</strong> <span id="routine-soir">10 min de lecture l√©g√®re, sans √©cran</span></div></div>
      </div>
    </div>
  </div>

  <div class="conseil-section">
    <div class="conseil-card">
      <div class="conseil-title">üí° Le saviez-vous ?</div>
      <div class="conseil-text" id="conseilText">Le curcuma et le magn√©sium sont de pr√©cieux alli√©s contre la fatigue et le stress. Le curcuma module l'inflammation, tandis que le magn√©sium participe √† plus de 300 r√©actions enzymatiques dont la production d'√©nergie.</div>
    </div>
  </div>
  <div class="scroll-pad"></div>
</div>

<button class="generate-btn" id="generateBtn" onclick="ouvrirConfig()">
  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/></svg>
  Nouveau plan
</button>

<script>
var SUPABASE_URL = 'https://ptzmyuugxhsbrynjwlhp.supabase.co'
var SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB0em15dXVneGhzYnJ5bmp3bGhwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwNDY1NjUsImV4cCI6MjA4NTYyMjU2NX0.Pel8am6iplwwFSqolEV7JOG6nxsOx4BxxJPLsObRC-4'

var selectedSymptoms = ['fatigue','stress']
var selectedRegimes = ['sans_gluten']
var currentPlan = null
var profilUtilisateur = null
var currentHistoriqueId = null
var recipeServings = {matin:1,midi:1,apres_midi:1,soir:1}
var recipeBaseIng = {}
var savedRecipes = []

document.addEventListener('DOMContentLoaded', function() {
  var opts = {weekday:'long',day:'numeric',month:'short'}
  document.getElementById('dateBadge').textContent = new Date().toLocaleDateString('fr-FR',opts)
  afficherEtoiles(8)
  chargerSauvegardees()

  var urlParams = new URLSearchParams(window.location.search)
  var profilId = urlParams.get('profil_id') || localStorage.getItem('vitalia_profil_id')
  var modeDemo = urlParams.get('demo') === 'true'

  if (profilId && profilId !== 'new') {
    // ‚úÖ Utilisateur connu ‚Äî charger profil et g√©n√©rer plan
    localStorage.setItem('vitalia_profil_id', profilId)
    var pl = localStorage.getItem('vitalia_profil')
    if (pl) { try { profilUtilisateur = JSON.parse(pl); appliquerProfil(profilUtilisateur) } catch(e){} }
    chargerProfilSupabase(profilId)

    // Restaurer plan depuis session si disponible (protection refresh mobile)
    var planSession = sessionStorage.getItem('vitalia_plan_session')
    if (planSession) {
      try {
        var planRestaure = JSON.parse(planSession)
        setTimeout(function(){
          document.getElementById('loadingScreen').style.opacity='0'
          document.getElementById('loadingScreen').style.pointerEvents='none'
          document.getElementById('app').style.opacity='1'
          afficherPlan(planRestaure)
          enregistrerIngredientsBase()
        }, 600)
      } catch(e) { setTimeout(function(){ genererPlan() }, 500) }
    } else {
      setTimeout(function(){ genererPlan() }, 500)
    }

  } else if (modeDemo) {
    // üé≠ Mode d√©mo explicite (?demo=true)
    setTimeout(function(){
      document.getElementById('loadingScreen').style.opacity = '0'
      document.getElementById('loadingScreen').style.pointerEvents = 'none'
      document.getElementById('app').style.opacity = '1'
      enregistrerIngredientsBase()
      ajouterActionsBarStatique()
      setTimeout(function(){ var fb=document.getElementById('feedbackBar'); if(fb) fb.style.display='flex' },3000)
    }, 1800)

  } else {
    // üö™ Pas de profil ‚Üí rediriger vers onboarding
    var lt = document.getElementById('loadingText')
    if (lt) {
      lt.innerHTML = 'Bienvenue sur Vitalia ! üåø<br><small style="font-size:14px;opacity:0.7">Cr√©ation de ton profil...</small>'
    }
    setTimeout(function(){
      window.location.href = 'onboarding.html'
    }, 1200)
  }
})

function enregistrerIngredientsBase() {
  ['matin','midi','apres_midi','soir'].forEach(function(m){
    var el = document.getElementById('ing-'+m)
    if (el) recipeBaseIng[m] = el.innerHTML
  })
}

function ajouterActionsBarStatique() {
  ['matin','midi','apres_midi','soir'].forEach(function(m){
    var content = document.querySelector('#instructions-'+m+' .instructions-content')
    if (content && !content.querySelector('.recipe-actions')) {
      var bar = document.createElement('div')
      bar.innerHTML = buildActionsBar(m)
      content.appendChild(bar.firstChild)
    }
  })
}

async function chargerProfilSupabase(id) {
  try {
    var r = await fetch(SUPABASE_URL+'/rest/v1/profils_utilisateurs?id=eq.'+id+'&limit=1',{headers:{'apikey':SUPABASE_ANON_KEY,'Authorization':'Bearer '+SUPABASE_ANON_KEY}})
    if (r.ok) { var d=await r.json(); if(d&&d[0]){profilUtilisateur=d[0];appliquerProfil(d[0]);localStorage.setItem('vitalia_profil',JSON.stringify(d[0]))} }
  } catch(e) {}
}

function appliquerProfil(p) {
  if (!p) return
  if (p.objectifs_generaux&&p.objectifs_generaux.length) selectedSymptoms=p.objectifs_generaux
  if (p.regimes_alimentaires&&p.regimes_alimentaires.length) selectedRegimes=p.regimes_alimentaires
  if (p.prenom) document.getElementById('heroMessage').textContent='Bonjour '+p.prenom+' ! Pr√™t √† prendre soin de toi ? üåø'
}

async function genererPlan() {
  fermerConfig()
  sessionStorage.removeItem('vitalia_plan_session')

  var profilId = new URLSearchParams(window.location.search).get('profil_id')||localStorage.getItem('vitalia_profil_id')||null

  // S√©curit√© : sans profil, on ne peut pas g√©n√©rer un vrai plan
  if (!profilId || profilId === 'new') {
    window.location.href = 'onboarding.html'
    return
  }

  document.getElementById('loadingScreen').style.opacity='1'
  document.getElementById('loadingScreen').style.pointerEvents='all'
  document.getElementById('app').style.opacity='0'

  try {
    var body = {profil_id:profilId,symptomes:selectedSymptoms,preferences_moment:{temps_max:parseInt(document.getElementById('tempsMax').value),budget_max:parseInt(document.getElementById('budgetMax').value)},force_regeneration:true}

    var r = await fetch(SUPABASE_URL+'/functions/v1/generer-plan',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+SUPABASE_ANON_KEY},body:JSON.stringify(body)})
    if (!r.ok) throw new Error('Erreur serveur '+r.status)
    var data = await r.json()
    if (data.success&&data.plan) {
      afficherPlan(data.plan)
      sessionStorage.setItem('vitalia_plan_session',JSON.stringify(data.plan))
    } else throw new Error(data.error||'Plan invalide')
  } catch(err) {
    console.error(err)
    alert('Erreur : '+err.message)
  } finally {
    document.getElementById('loadingScreen').style.opacity='0'
    document.getElementById('loadingScreen').style.pointerEvents='none'
    document.getElementById('app').style.opacity='1'
  }
}

function afficherPlan(plan) {
  currentPlan = plan
  document.getElementById('heroMessage').textContent = plan.message_personnalise||'Ton plan est pr√™t ! üåø'
  var score = plan.score_nutritionnel||7
  document.getElementById('scoreValue').textContent = score+'/10'
  afficherEtoiles(score)
  ;['matin','midi','apres_midi','soir'].forEach(function(m){
    var d=plan[m]; if(!d) return
    setText(m+'-time',d.heure_suggere||'')
    setText(m+'-titre',d.titre||'')
    setText(m+'-desc',d.description||'')
    setText(m+'-motivant',d.message_motivant||'')
    setText(m+'-cal',(d.calories_estimees||'‚Äî')+' kcal')
    renderInstructions(m,d.instructions)
    recipeServings[m]=1
  })
  var r=plan.routine_du_jour||{}
  if(r.matin)setText('routine-matin',r.matin)
  if(r.complement_phare)setText('routine-complement',r.complement_phare)
  if(r.aromatherapie)setText('routine-aroma',r.aromatherapie)
  if(r.soir)setText('routine-soir',r.soir)
  if(plan.conseil_du_jour)setText('conseilText',plan.conseil_du_jour)
  loggerPlanVu(plan)
  var fb=document.getElementById('feedbackBar')
  if(fb){fb.style.display='flex';document.querySelectorAll('.feedback-star').forEach(function(s){s.classList.remove('lit')});var s=document.getElementById('feedbackSent');if(s)s.classList.remove('show');document.getElementById('feedbackStars').style.display='flex'}
}

function setText(id,val){var e=document.getElementById(id);if(e)e.textContent=val}

function renderInstructions(moment,data) {
  var el = document.getElementById(moment+'-instructions'); if(!el) return
  var ingHtml='',stepsHtml='',tipHtml=''
  if (data&&typeof data==='object'&&!Array.isArray(data)&&data.steps) {
    if(data.ingredients&&data.ingredients.length)
      ingHtml='<div class="instructions-section-label">Ingr√©dients</div><div class="instructions-ingredients" id="ing-'+moment+'">'+data.ingredients.map(function(i){return'<span class="ingredient-tag">'+i+'</span>'}).join('')+'</div>'
    stepsHtml='<div class="instructions-section-label">Pr√©paration</div><div class="instructions-steps">'+data.steps.map(function(s,n){return'<div class="instruction-step"><div class="step-num">'+(n+1)+'</div><div class="step-text">'+s+'</div></div>'}).join('')+'</div>'
    tipHtml=data.tip?'<div class="instructions-tip"><strong>Astuce :</strong> '+data.tip+'</div>':''
  } else if(typeof data==='string'&&data.trim()) {
    var t=data.trim(),lines=t.indexOf('\n')>=0?t.split('\n'):t.split('. ').map(function(s,i,a){return i<a.length-1?s+'.':s})
    var steps=lines.map(function(l){return l.replace(/^\d+[.)]\s*/,'').trim()}).filter(function(l){return l.length>10})
    stepsHtml='<div class="instructions-section-label">Pr√©paration</div><div class="instructions-steps">'+(steps.length>=2?steps:[t]).map(function(s,n){return'<div class="instruction-step"><div class="step-num">'+(n+1)+'</div><div class="step-text">'+s+'</div></div>'}).join('')+'</div>'
  } else if(data) stepsHtml='<div class="step-text">'+String(data)+'</div>'

  el.innerHTML='<div class="instructions-content">'+ingHtml+stepsHtml+tipHtml+'</div>'
  // Ajout actions bar
  var content=el.querySelector('.instructions-content')
  if(content){var bar=document.createElement('div');bar.innerHTML=buildActionsBar(moment);content.appendChild(bar.firstChild)}
  var ingEl=el.querySelector('.instructions-ingredients'); if(ingEl) recipeBaseIng[moment]=ingEl.innerHTML
}

function buildActionsBar(m) {
  return '<div class="recipe-actions" onclick="event.stopPropagation()">' +
    '<div class="servings-stepper"><span class="servings-label">Portions</span>' +
    '<button class="stepper-btn" onclick="changerPortions(\''+m+'\',-1)">&#8722;</button>' +
    '<span class="stepper-count" id="count-'+m+'">1</span>' +
    '<button class="stepper-btn" onclick="changerPortions(\''+m+'\',1)">+</button></div>' +
    '<div class="recipe-rating"><span class="recipe-rating-label">Note</span><div class="recipe-stars" id="stars-'+m+'">'+
    [1,2,3,4,5].map(function(n){return'<span class="recipe-star" onclick="noterRecette(\''+m+'\','+n+')">&#11088;</span>'}).join('')+'</div></div>' +
    '<button class="save-recipe-btn" id="save-btn-'+m+'" onclick="sauvegarderRecette(\''+m+'\')">&#128278; Sauvegarder</button>' +
  '</div>'
}

function changerPortions(m,delta){
  recipeServings[m]=Math.max(1,Math.min(8,(recipeServings[m]||1)+delta))
  var c=document.getElementById('count-'+m); if(c) c.textContent=recipeServings[m]
  var ingEl=document.querySelector('#instructions-'+m+' .instructions-ingredients')
  if(ingEl&&recipeBaseIng[m]){
    var tmp=document.createElement('div'); tmp.innerHTML=recipeBaseIng[m]
    tmp.querySelectorAll('.ingredient-tag').forEach(function(t){t.textContent=ajusterQuantite(t.textContent,recipeServings[m])})
    ingEl.innerHTML=tmp.innerHTML
  }
}

function ajusterQuantite(text,portions){
  return text.replace(/(\d+(?:[.,]\d+)?)\s*(g|kg|ml|cl|l|c\.a\.s|c\.a\.c|tbsp|tsp|oz|lb)/gi,function(_,num,unit){
    return (Math.round(parseFloat(num.replace(',','.'))*portions*10)/10)+' '+unit
  })
}

async function noterRecette(m,note){
  var c=document.getElementById('stars-'+m); if(c) c.querySelectorAll('.recipe-star').forEach(function(s,i){s.classList.toggle('lit',i<note)})
  var titre=currentPlan&&currentPlan[m]?currentPlan[m].titre:''
  var ex=savedRecipes.find(function(r){return r.moment===m&&r.titre===titre})
  if(ex){
    ex.note=note; sauvegarderLocal()
    if(document.getElementById('savedPanel').classList.contains('open')) renderSavedList()
    afficherToast('Note sauvegard√©e !')
    // Sync Supabase
    if(ex.supabase_id){
      try {
        await fetch(SUPABASE_URL+'/rest/v1/recettes_sauvegardees?id=eq.'+ex.supabase_id,{
          method:'PATCH',
          headers:{'Content-Type':'application/json','apikey':SUPABASE_ANON_KEY,'Authorization':'Bearer '+SUPABASE_ANON_KEY},
          body:JSON.stringify({note:note})
        })
      } catch(e){}
    }
  }
}

async function sauvegarderRecette(m){
  var titre=currentPlan&&currentPlan[m]?currentPlan[m].titre:(document.getElementById(m+'-titre')||{}).textContent||'Recette'
  var idx=savedRecipes.findIndex(function(r){return r.moment===m&&r.titre===titre})
  var btn=document.getElementById('save-btn-'+m)
  if(idx>=0){
    var existant=savedRecipes[idx]
    savedRecipes.splice(idx,1)
    if(btn){btn.innerHTML='&#128278; Sauvegarder';btn.classList.remove('saved')}
    afficherToast('Recette retir√©e des favoris')
    sauvegarderLocal(); majCompteur()
    if(existant&&existant.supabase_id) _supprimerSupabase(existant.supabase_id)
  } else {
    if(savedRecipes.length>=50) savedRecipes.shift()
    var ings=[]
    var ingEl=document.querySelector('#instructions-'+m+' .instructions-ingredients')
    if(ingEl) ings=Array.from(ingEl.querySelectorAll('.ingredient-tag')).map(function(t){return t.textContent})
    var steps=[]
    document.querySelectorAll('#instructions-'+m+' .step-text').forEach(function(s){steps.push(s.textContent)})
    var tip=''
    var tipEl=document.querySelector('#instructions-'+m+' .instructions-tip')
    if(tipEl) tip=tipEl.textContent.replace(/^Astuce\s*:\s*/,'')
    var entry={id:Date.now()+'-'+m,supabase_id:null,moment:m,titre:titre,date:new Date().toLocaleDateString('fr-FR',{day:'numeric',month:'short'}),note:null,ingredients:ings,steps:steps,tip:tip}
    savedRecipes.push(entry)
    if(btn){btn.innerHTML='&#10003; Sauvegard√©e';btn.classList.add('saved')}
    afficherToast('Recette sauvegard√©e ! üîñ')
    sauvegarderLocal(); majCompteur()
    // Sync Supabase en arri√®re-plan
    var profilId=localStorage.getItem('vitalia_profil_id')
    if(profilId&&profilId!=='new'){
      var sid=await _upsertSupabase(entry,profilId)
      if(sid){ entry.supabase_id=sid; entry.id=sid; sauvegarderLocal() }
    }
  }
}

// ‚îÄ‚îÄ‚îÄ PERSISTANCE : localStorage + Supabase ‚îÄ‚îÄ‚îÄ

function sauvegarderLocal(){
  localStorage.setItem('vitalia_saved_recipes', JSON.stringify(savedRecipes))
}

function majCompteur(){
  var e=document.getElementById('savedCount'); if(e) e.textContent=savedRecipes.length
}

// Chargement initial : localStorage d'abord (instantan√©), puis sync Supabase
function chargerSauvegardees(){
  var s=localStorage.getItem('vitalia_saved_recipes')
  if(s){try{savedRecipes=JSON.parse(s)}catch(e){savedRecipes=[]}}
  majCompteur()
  // Sync Supabase en arri√®re-plan si profil connect√©
  var profilId=localStorage.getItem('vitalia_profil_id')
  if(profilId&&profilId!=='new') syncDepuisSupabase(profilId)
}

// Charger depuis Supabase et fusionner avec localStorage
async function syncDepuisSupabase(profilId){
  try {
    var r=await fetch(SUPABASE_URL+'/rest/v1/recettes_sauvegardees?profil_id=eq.'+profilId+'&order=date_sauvegarde.desc&limit=50',{
      headers:{'apikey':SUPABASE_ANON_KEY,'Authorization':'Bearer '+SUPABASE_ANON_KEY}
    })
    if(!r.ok) return
    var data=await r.json()
    if(!data||!data.length) return

    // Convertir format Supabase ‚Üí format local
    var fromServer=data.map(function(row){
      return {
        id: row.id,                // UUID Supabase = source de v√©rit√©
        supabase_id: row.id,
        moment: row.moment,
        titre: row.titre,
        date: new Date(row.date_sauvegarde).toLocaleDateString('fr-FR',{day:'numeric',month:'short'}),
        note: row.note||null,
        ingredients: row.ingredients||[],
        steps: row.steps||[],
        tip: row.tip||''
      }
    })

    // Fusionner : Supabase est la source de v√©rit√©, on ajoute les locales non encore sync
    var titresServeur=fromServer.map(function(r){return r.titre})
    var localSeulement=savedRecipes.filter(function(r){return !r.supabase_id&&!titresServeur.includes(r.titre)})

    savedRecipes=fromServer.concat(localSeulement)
    sauvegarderLocal()
    majCompteur()

    // Upload les recettes locales non encore sur Supabase
    localSeulement.forEach(function(r){ _upsertSupabase(r, profilId) })

    // Rafra√Æchir le panneau si ouvert
    if(document.getElementById('savedPanel').classList.contains('open')) renderSavedList()
    console.log('‚úÖ Sync Supabase : '+fromServer.length+' recettes charg√©es')
  } catch(e){ console.log('‚ÑπÔ∏è Sync Supabase indisponible, localStorage utilis√©') }
}

// Upsert une recette vers Supabase
async function _upsertSupabase(recette, profilId){
  profilId=profilId||localStorage.getItem('vitalia_profil_id')
  if(!profilId||profilId==='new') return null
  try {
    var body={
      profil_id: profilId,
      moment: recette.moment,
      titre: recette.titre,
      ingredients: recette.ingredients||[],
      steps: recette.steps||[],
      tip: recette.tip||'',
      note: recette.note||null
    }
    // Si on a d√©j√† un UUID Supabase on fait un PATCH, sinon POST
    var url=SUPABASE_URL+'/rest/v1/recettes_sauvegardees'
    var method='POST'
    var prefer='return=representation'
    if(recette.supabase_id){
      url+='?id=eq.'+recette.supabase_id
      method='PATCH'
    } else {
      // Upsert par (profil_id, titre)
      url+='?on_conflict=profil_id,titre'
      prefer='return=representation,resolution=merge-duplicates'
    }
    var r=await fetch(url,{
      method:method,
      headers:{'Content-Type':'application/json','apikey':SUPABASE_ANON_KEY,'Authorization':'Bearer '+SUPABASE_ANON_KEY,'Prefer':prefer},
      body:JSON.stringify(body)
    })
    if(r.ok){
      var d=await r.json()
      var row=Array.isArray(d)?d[0]:d
      return row?row.id:null
    }
  } catch(e){ console.log('‚ÑπÔ∏è Upsert Supabase √©chou√©, localStorage conserv√©') }
  return null
}

// Supprimer depuis Supabase
async function _supprimerSupabase(supabaseId){
  if(!supabaseId) return
  try {
    await fetch(SUPABASE_URL+'/rest/v1/recettes_sauvegardees?id=eq.'+supabaseId,{
      method:'DELETE',
      headers:{'apikey':SUPABASE_ANON_KEY,'Authorization':'Bearer '+SUPABASE_ANON_KEY}
    })
  } catch(e){}
}

// ‚îÄ‚îÄ‚îÄ PANEL SAUVEGARD√âES ‚îÄ‚îÄ‚îÄ

function ouvrirSauvegardees(){
  renderSavedList()
  document.getElementById('savedPanel').classList.add('open')
  document.getElementById('overlay').classList.add('active')
}

function fermerSauvegardees(){
  document.getElementById('savedPanel').classList.remove('open')
  document.getElementById('overlay').classList.remove('active')
}

function renderSavedList(){
  var l=document.getElementById('savedList'); if(!l) return
  if(!savedRecipes.length){
    l.innerHTML='<div class="saved-empty"><div class="saved-empty-icon">üçÉ</div><div>Aucune recette sauvegard√©e.<br>Ouvre une recette et clique sur Sauvegarder !</div></div>'
    return
  }
  l.innerHTML=savedRecipes.slice().reverse().map(function(r){
    var starsHtml=r.note
      ? [1,2,3,4,5].map(function(n){return'<span style="font-size:14px;filter:'+(n<=r.note?'none':'grayscale(1) opacity(0.3)')+'">&#11088;</span>'}).join('')
      : '<span style="color:var(--text-light);font-size:11px">Non not√©e</span>'
    var ingHtml=r.ingredients&&r.ingredients.length
      ? '<div class="saved-item-ingredients">'+r.ingredients.map(function(i){return'<span class="saved-ing-tag">'+i+'</span>'}).join('')+'</div>' : ''
    var stepsHtml=r.steps&&r.steps.length
      ? '<div class="saved-item-steps">'+r.steps.map(function(s,n){return'<div class="saved-step"><span class="saved-step-num">'+(n+1)+'</span><span>'+s+'</span></div>'}).join('')+'</div>' : ''
    var tipHtml=r.tip?'<div class="saved-item-tip"><strong>Astuce :</strong> '+r.tip+'</div>':''
    var detailId='detail-'+String(r.id).replace(/[^a-z0-9]/gi,'')
    var syncIcon=r.supabase_id?'<span title="Synchronis√©" style="font-size:10px;color:var(--sage)">‚òÅÔ∏è</span>':'<span title="Local uniquement" style="font-size:10px;color:var(--text-light)">üì±</span>'
    return '<div class="saved-item">'+
      '<div class="saved-item-header" onclick="toggleSavedDetail(\''+detailId+'\',this)">'+
        '<div style="flex:1;min-width:0">'+
          '<div class="saved-item-title">'+r.titre+'</div>'+
          '<div class="saved-item-meta"><span>üìÖ '+r.date+'</span>'+syncIcon+'<div class="saved-item-stars">'+starsHtml+'</div></div>'+
        '</div>'+
        '<div style="display:flex;align-items:center;gap:6px;flex-shrink:0">'+
          '<span class="saved-expand-arrow">‚ñº</span>'+
          '<button class="saved-item-delete" onclick="event.stopPropagation();supprimerSauvegardee(\''+r.id+'\')">‚úï</button>'+
        '</div>'+
      '</div>'+
      '<div class="saved-item-detail" id="'+detailId+'" style="max-height:0;overflow:hidden;transition:max-height 0.35s ease">'+
        ingHtml+stepsHtml+tipHtml+
      '</div>'+
    '</div>'
  }).join('')
}

function toggleSavedDetail(id,header){
  var el=document.getElementById(id); if(!el) return
  var arrow=header.querySelector('.saved-expand-arrow')
  var isOpen=el.style.maxHeight&&el.style.maxHeight!=='0px'
  el.style.maxHeight=isOpen?'0px':el.scrollHeight+'px'
  if(arrow) arrow.textContent=isOpen?'‚ñº':'‚ñ≤'
}

async function supprimerSauvegardee(id){
  var r=savedRecipes.find(function(r){return String(r.id)===String(id)})
  savedRecipes=savedRecipes.filter(function(r){return String(r.id)!==String(id)})
  sauvegarderLocal(); majCompteur(); renderSavedList()
  if(r&&r.supabase_id) _supprimerSupabase(r.supabase_id)
}

function fermerTout(){fermerConfig();fermerSauvegardees()}

async function loggerPlanVu(plan){
  var profilId=localStorage.getItem('vitalia_profil_id'); if(!profilId||profilId==='new') return
  try {
    var r=await fetch(SUPABASE_URL+'/rest/v1/historique_recommandations',{method:'POST',headers:{'Content-Type':'application/json','apikey':SUPABASE_ANON_KEY,'Authorization':'Bearer '+SUPABASE_ANON_KEY,'Prefer':'return=representation'},body:JSON.stringify({profil_id:profilId,symptomes_declares:selectedSymptoms,plan_json:plan,date_utilisation:new Date().toISOString()})})
    if(r.ok){var d=await r.json();if(d&&d[0])currentHistoriqueId=d[0].id}
  } catch(e){}
}

async function noterPlan(note){
  document.querySelectorAll('.feedback-star').forEach(function(s,i){s.classList.toggle('lit',i<note)})
  setTimeout(function(){document.getElementById('feedbackStars').style.display='none';var s=document.getElementById('feedbackSent');if(s)s.classList.add('show')},400)
  afficherToast(note>=4?'üéâ Super ! On am√©liore tes prochains plans !':note>=3?'üëç Not√© ! On diversifie la suite':'üîÑ Compris ! Plan plus vari√© demain')
  if(currentHistoriqueId){try{await fetch(SUPABASE_URL+'/rest/v1/historique_recommandations?id=eq.'+currentHistoriqueId,{method:'PATCH',headers:{'Content-Type':'application/json','apikey':SUPABASE_ANON_KEY,'Authorization':'Bearer '+SUPABASE_ANON_KEY},body:JSON.stringify({note_satisfaction:note,feedback_donne_le:new Date().toISOString()})})}catch(e){}}
}

function afficherEtoiles(score){
  var c=document.getElementById('starsContainer'),html='',p=Math.floor(score/2),d=score%2
  for(var i=0;i<p;i++)html+='<span class="star">&#11088;</span>'
  if(d)html+='<span class="star">&#10024;</span>'
  c.innerHTML=html
}

function afficherToast(msg){
  var t=document.getElementById('toast'); if(!t) return
  t.textContent=msg; t.classList.add('show')
  setTimeout(function(){t.classList.remove('show')},3000)
}

function toggleInstructions(m,event){
  if(event&&event.target.closest&&event.target.closest('.recipe-actions')) return
  var el=document.getElementById('instructions-'+m),btn=document.getElementById('btn-'+m); if(!el) return
  el.classList.toggle('open'); if(btn) btn.textContent=el.classList.contains('open')?'‚ñ≤':'‚ñº'
  if(el.classList.contains('open')&&!recipeBaseIng[m]){var ingEl=el.querySelector('.instructions-ingredients');if(ingEl)recipeBaseIng[m]=ingEl.innerHTML}
}

function ouvrirConfig(){document.getElementById('configPanel').classList.add('open');document.getElementById('overlay').classList.add('active')}
function fermerConfig(){document.getElementById('configPanel').classList.remove('open');document.getElementById('overlay').classList.remove('active')}

function toggleChip(el,val){
  el.classList.toggle('selected')
  if(el.dataset.regime){if(el.classList.contains('selected')){if(!selectedRegimes.includes(val))selectedRegimes.push(val)}else selectedRegimes=selectedRegimes.filter(function(r){return r!==val})}
  else{if(el.classList.contains('selected')){if(!selectedSymptoms.includes(val))selectedSymptoms.push(val)}else selectedSymptoms=selectedSymptoms.filter(function(s){return s!==val})}
}
</script>
</body>
</html>
